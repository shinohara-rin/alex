## 拟人化LLM对话App：详细实施文档

### 1. 项目目标与核心理念

**项目目标：** 开发一个概念验证（PoC）应用，模拟一个具有独立人格、状态和自主行为的AI代理，实现与用户之间高度拟人化、非回合制的对话体验。

**核心理念：** 将AI从一个被动的“应答工具”转变为一个主动的、有状态的“虚拟伙伴”。AI代理应拥有自己的内部状态、独立的时间线和自主决策能力。

### 2. 功能性需求 (Functional Requirements)

|需求ID|需求名称|描述|
|---|---|---|
|**FR1**|**异步聊天接口**|用户界面必须支持异步消息收发。用户可以连续发送消息而无需等待AI回复。AI可以在任何时候主动向用户发送一条或多条消息。|
|**FR2**|**代理状态管理**|系统必须能够存储和动态更新AI代理的内部状态。该状态至少应包括：情绪(mood)、当前思绪(current_thoughts)、最近活动(last_activity)等。|
|**FR3**|**自主“心跳”循环**|系统必须有一个独立于用户交互的后台进程（“心跳”），以固定的时间间隔（可配置，如每15分钟）触发，模拟AI代理的独立思考过程。|
|**FR4**|**主动行为能力**|在“心跳”循环中，AI代理能够基于其内部状态和思考结果，自主决策是否要向用户发起新的对话或分享想法。|
|**FR5**|**选择性回复机制**|当接收到用户消息时，AI代理必须能够自主决策是否回复、何时回复（立即、稍后、或不回复），而不是机械地应答每一条消息。|
|**FR6**|**深度人格模拟**|AI代理的行为和语言风格必须严格遵循一个预设的、详尽的人格档案（Persona），包括其背景、性格、兴趣、价值观和行为准则。|

### 3. 非功能性需求 (Non-Functional Requirements)

|需求ID|需求名称|描述|
|---|---|---|
|**NFR1**|**可扩展性**|架构设计应具备良好的模块化，便于未来增加新的代理角色、新的行为能力或接入更复杂的记忆系统。|
|**NFR2**|**界面响应性**|前端界面必须流畅，能够实时、无延迟地展示新消息（包括AI主动发送的消息），并提供良好的用户体验，如消息发送状态、打字中提示等。|
|**NFR3**|**数据持久化**|对话历史、代理人格和代理状态必须被持久化存储，确保在服务重启或用户重新登录后，所有上下文信息都得以保留。|
|**NFR4**|**可配置性**|关键参数，如“心跳”频率、人格档案等，应易于配置和修改，方便进行实验和调整。|

### 4. 架构设计与最佳实现方向

我们将采用经典的前后端分离架构。

#### 4.1. 前端 (Single Page Application - SPA)

- **技术选型推荐：** **React** (配合 Create React App 或 Vite) 或 **Vue.js** (配合 Vue CLI 或 Vite)。两者都拥有强大的生态和成熟的状态管理方案。
    
- **核心实现：**
    
    1. **通信协议：** **WebSocket** 是第一选择。使用 `socket.io-client` (React/Vue) 或原生WebSocket API与后端建立长连接。这是实现FR1（异步聊天）的关键。
        
    2. **状态管理：**
        
        - **React:** 使用 **Redux Toolkit** 或 **Zustand** 来管理全局状态，如聊天记录、连接状态、AI代理的在线状态等。
            
        - **Vue:** 使用 **Pinia**。
            
    3. **UI/UX最佳实践：**
        
        - **乐观UI (Optimistic UI):** 用户发送消息后，立即将其显示在界面上并标记为“发送中”，待收到后端确认后再更新为“已送达”。
            
        - **实时反馈：** 当AI正在“思考”或“输入”时，显示打字中 (…) 的提示。这可以通过后端在生成消息前通过WebSocket发送一个`typing_start`事件来实现。
            
        - **消息组件：** 消息组件需要能清晰地区分用户消息和AI消息，并能展示不同的状态（发送中、已送达、已读）。
            

#### 4.2. 后端 (Backend Service)

- **技术选型推荐：** **Python + FastAPI**。FastAPI基于Starlette和Pydantic，天生支持异步操作（`async/await`），性能卓越，且对WebSocket有良好支持，是本项目场景的理想选择。
    
- **核心实现：**
    
    1. **WebSocket管理：** FastAPI内置了对WebSocket的支持。你需要创建一个WebSocket端点（`/ws`），用于管理与客户端的连接，并处理双向消息流。
        
    2. **“心跳”任务调度器：** 使用 **APScheduler**。在FastAPI应用启动时，将APScheduler作为一个后台任务运行。配置一个间隔性作业（`interval` job）来定期调用“内部独白”和“主动行为”的逻辑。
        
    3. **LLM服务层：** 将所有与LLM API（如Gemini API）的交互封装在一个独立的服务模块中。这个模块负责：
        
        - 构建不同场景下的Prompt（对话、决策、思考）。
            
        - 处理API请求和响应。
            
        - 管理API密钥和错误重试逻辑。
            
        - **强制JSON输出：** 对于需要结构化输出的LLM调用（如决策和状态更新），利用LLM的JSON模式功能来确保返回格式的稳定性。
            
    4. **业务逻辑（核心三层）：**
        
        - **接收用户消息：** WebSocket收到消息后，不直接调用LLM生成回复，而是将其放入一个处理队列，并触发**“回复决策”**逻辑（FR5）。
            
        - **心跳循环逻辑：** 由APScheduler触发。首先执行**“内部独白”**，更新数据库中的`agent_state`；然后执行**“主动行为决策”**，如果决策为真，则生成消息并通过WebSocket发送给前端（FR3, FR4）。
            
        - **消息生成：** 无论是回复用户还是主动发起，最终都调用LLM服务层生成对话内容。
            

#### 4.3. 数据库 (Database)

- **技术选型推荐：** **MongoDB**。作为一种NoSQL文档数据库，MongoDB非常适合存储本项目中大量半结构化的JSON数据，如聊天记录和AI代理状态。
    
- **数据模型（Schema）设计建议：**
    
    - **`agents` 集合：**
        
        ```
        {
          "_id": "agent_001",
          "name": "林悦",
          "persona": { // 静态人格档案 (FR6)
            "background": "一位28岁的独立摄影师，住在上海...",
            "mbti": "INFP",
            "values": ["艺术", "自由", "真诚"],
            ...
          },
          "state": { // 动态状态 (FR2)
            "mood": "平静",
            "current_thoughts": "在想要不要去看看周末的影展。",
            "last_activity": "整理了昨晚拍的照片",
            "updated_at": "2025-07-05T16:40:00Z"
          }
        }
        ```
        
    - **`conversations` 集合：**
        
        ```
        {
          "_id": "conv_user1_agent1",
          "user_id": "user_123",
          "agent_id": "agent_001",
          "messages": [
            {
              "id": "msg_001",
              "sender": "user", // "user" or "agent"
              "text": "你好啊",
              "timestamp": "2025-07-05T16:30:00Z",
              "status": "seen"
            },
            {
              "id": "msg_002",
              "sender": "agent",
              "text": "嗨，下午好。刚忙完，正想歇会儿。",
              "timestamp": "2025-07-05T16:32:00Z"
            }
          ]
        }
        ```
        

### 5. 开发路线图 (Staged Implementation)

建议分阶段进行开发，逐步验证核心功能。

- **阶段一：基础通信框架**
    
    - **目标：** 搭建前后端，实现基础的、实时的、回合制聊天。
        
    - **任务：**
        
        1. 初始化React/Vue前端项目和FastAPI后端项目。
            
        2. 实现WebSocket连接。
            
        3. 实现一个简单的聊天界面，用户发送消息，后端调用LLM生成回复并返回。
            
        4. 集成MongoDB，开始存储对话历史。
            
- **阶段二：状态化的代理**
    
    - **目标：** 让AI拥有记忆和状态。
        
    - **任务：**
        
        1. 在数据库中创建`agents`集合，并定义`state`结构。
            
        2. 改造所有LLM调用，使其在Prompt中包含当前的`agent_state`。
            
        3. 让LLM在生成回复的同时，也生成新的`state`并更新到数据库。
            
- **阶段三：赋予独立生命（心跳）**
    
    - **目标：** 让AI在没有用户交互时也能“思考”。
        
    - **任务：**
        
        1. 在FastAPI后端集成APScheduler。
            
        2. 编写“内部独白”的逻辑和Prompt。
            
        3. 设置定时任务，定期执行独白并更新`agent_state`。
            
- **阶段四：实现完全自主**
    
    - **目标：** 实现主动发起对话和选择性回复。
        
    - **任务：**
        
        1. 在心跳循环中加入“主动行为决策”逻辑，允许AI通过WebSocket主动推送消息。
            
        2. 在后端接收用户消息的流程中，插入“回复决策”逻辑，实现延迟回复或不回复。
            
- **阶段五：体验优化与打磨**
    
    - **目标：** 提升产品的可用性和拟人化程度。
        
    - **任务：**
        
        1. 在前端实现“打字中”提示、消息状态更新等高级UI功能。
            
        2. 精调所有人格和决策的Prompt，使AI的行为更自然、更符合人设。
            
        3. 进行测试和Bug修复。